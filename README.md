# Go-IM â€”â€” åŸºäº Go ä¸ Redis çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼å³æ—¶é€šè®¯ç³»ç»Ÿ

> ä¸€ä¸ªé¢å‘å­¦ä¹ çš„åˆ†å¸ƒå¼ IM ç³»ç»Ÿ Demoï¼Œä»£ç æœ‰è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼Œé€‚åˆå­¦ä¹  Go é«˜å¹¶å‘ç½‘ç»œç¼–ç¨‹å’Œ Redis å®æˆ˜åº”ç”¨ã€‚

---

## ğŸ“š ç›®å½•

- [é¡¹ç›®èƒŒæ™¯](#é¡¹ç›®èƒŒæ™¯)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ä»£ç å¯¼è¯»](#ä»£ç å¯¼è¯»)
- [Redis æ•°æ®ç»“æ„](#redis-æ•°æ®ç»“æ„)
- [å­¦ä¹ è·¯çº¿](#å­¦ä¹ è·¯çº¿)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## é¡¹ç›®èƒŒæ™¯

### ä¸ºä»€ä¹ˆåšè¿™ä¸ªé¡¹ç›®ï¼Ÿ

åœ¨å­¦ä¹ äº† Redis æºç ï¼ˆReactor æ¨¡å‹ã€IO å¤šè·¯å¤ç”¨ï¼‰å’Œ Linux ç³»ç»Ÿç¼–ç¨‹åï¼Œä¸ºäº†éªŒè¯**é«˜å¹¶å‘ç½‘ç»œæ¨¡å‹**åœ¨å®é™…ä¸šåŠ¡ä¸­çš„åº”ç”¨ï¼Œè®¾è®¡å¹¶å®ç°äº†è¿™å¥—åˆ†å¸ƒå¼å³æ—¶é€šè®¯ç³»ç»Ÿã€‚

### è§£å†³çš„é—®é¢˜

ä¼ ç»Ÿå•ä½“èŠå¤©å®¤çš„é—®é¢˜ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      å•ä½“èŠå¤©æœåŠ¡å™¨       â”‚
â”‚  - æ‰€æœ‰ç”¨æˆ·è¿æ¥åŒä¸€å°æœºå™¨  â”‚
â”‚  - æ— æ³•æ¨ªå‘æ‰©å±•           â”‚
â”‚  - å•ç‚¹æ•…éšœ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æœ¬é¡¹ç›®çš„è§£å†³æ–¹æ¡ˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åˆ†å¸ƒå¼æ¶æ„                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚Gateway-1 â”‚   â”‚Gateway-2 â”‚   â”‚Gateway-N â”‚   â”‚
â”‚  â”‚  (1ä¸‡è¿æ¥)â”‚   â”‚  (1ä¸‡è¿æ¥)â”‚   â”‚  (1ä¸‡è¿æ¥)â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚              â”‚              â”‚          â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                      â–¼                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚              â”‚     Redis     â”‚                 â”‚
â”‚              â”‚ (æ¶ˆæ¯è·¯ç”±ä¸­å¿ƒ)  â”‚                 â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æŠ€æœ¯æ ˆ

| ç±»åˆ« | æŠ€æœ¯ | ç”¨é€” |
|------|------|------|
| å¼€å‘è¯­è¨€ | Go 1.20+ | é«˜å¹¶å‘ç½‘ç»œç¼–ç¨‹ |
| æ•°æ®å­˜å‚¨ | Redis 6.0+ | çŠ¶æ€ç®¡ç†ã€æ¶ˆæ¯é˜Ÿåˆ—ã€Pub/Sub |
| é€šä¿¡åè®® | TCP è‡ªå®šä¹‰äºŒè¿›åˆ¶åè®® | è§£å†³ç²˜åŒ…é—®é¢˜ |
| è®¤è¯ | JWT | æ— çŠ¶æ€åˆ†å¸ƒå¼è®¤è¯ |
| å¹¶å‘æ¨¡å‹ | Goroutine-per-Connection | ç®€å•é«˜æ•ˆçš„å¹¶å‘å¤„ç† |

---

## ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚               Go-IM ç³»ç»Ÿ                â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                               â”‚                               â”‚
          â–¼                               â–¼                               â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Gateway-1  â”‚                 â”‚  Gateway-2  â”‚                 â”‚  Gateway-N  â”‚
   â”‚             â”‚                 â”‚             â”‚                 â”‚             â”‚
   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                 â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                 â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚ â”‚TCP Serverâ”‚ â”‚                 â”‚ â”‚TCP Serverâ”‚ â”‚                 â”‚ â”‚TCP Serverâ”‚ â”‚
   â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚                 â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚                 â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚
   â”‚      â”‚      â”‚                 â”‚      â”‚      â”‚                 â”‚      â”‚      â”‚
   â”‚ â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”‚                 â”‚ â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”‚                 â”‚ â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”‚
   â”‚ â”‚è¿æ¥ç®¡ç†å™¨â”‚ â”‚                 â”‚ â”‚è¿æ¥ç®¡ç†å™¨â”‚ â”‚                 â”‚ â”‚è¿æ¥ç®¡ç†å™¨â”‚ â”‚
   â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚                 â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚                 â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚
   â”‚      â”‚      â”‚                 â”‚      â”‚      â”‚                 â”‚      â”‚      â”‚
   â”‚ â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”‚                 â”‚ â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”‚                 â”‚ â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”‚
   â”‚ â”‚æ¶ˆæ¯å¤„ç†å™¨â”‚ â”‚                 â”‚ â”‚æ¶ˆæ¯å¤„ç†å™¨â”‚ â”‚                 â”‚ â”‚æ¶ˆæ¯å¤„ç†å™¨â”‚ â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚                               â”‚                               â”‚
          â”‚                        Pub/Sub è·¨èŠ‚ç‚¹é€šä¿¡                      â”‚
          â”‚                               â”‚                               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚           Redis              â”‚
                            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                            â”‚  â”‚ user_session:uid (Hash) â”‚â”‚ â† ç”¨æˆ·ä¼šè¯
                            â”‚  â”‚ user_gateway:uid (String)â”‚â”‚ â† ç”¨æˆ·ä½ç½®
                            â”‚  â”‚ msg_box:uid (ZSet)       â”‚â”‚ â† ç¦»çº¿æ¶ˆæ¯
                            â”‚  â”‚ seq:conversation (String)â”‚â”‚ â† æ¶ˆæ¯åºå·
                            â”‚  â”‚ channel:gateway_* (PubSub)â”‚ â† æ¶ˆæ¯è·¯ç”±
                            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶ˆæ¯æµè½¬å›¾

```
Alice (Gateway-1) å‘æ¶ˆæ¯ç»™ Bob (Gateway-2)

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Alice                                                   Bob     â”‚
    â”‚   â”‚                                                        â”‚     â”‚
    â”‚   â”‚ 1. å‘é€æ¶ˆæ¯                                            â”‚     â”‚
    â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶                         â”‚     â”‚
    â”‚   â”‚                              â”‚                         â”‚     â”‚
    â”‚   â”‚                        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                   â”‚     â”‚
    â”‚   â”‚                        â”‚ Gateway-1  â”‚                   â”‚     â”‚
    â”‚   â”‚                        â”‚ ç”Ÿæˆ SeqID â”‚                   â”‚     â”‚
    â”‚   â”‚                        â”‚ æŸ¥è¯¢ Bob   â”‚                   â”‚     â”‚
    â”‚   â”‚                        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                   â”‚     â”‚
    â”‚   â”‚                              â”‚                         â”‚     â”‚
    â”‚   â”‚                              â”‚ 2. æŸ¥è¯¢ user_gateway:bobâ”‚     â”‚
    â”‚   â”‚                              â–¼                         â”‚     â”‚
    â”‚   â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚     â”‚
    â”‚   â”‚                        â”‚   Redis   â”‚                   â”‚     â”‚
    â”‚   â”‚                        â”‚ è¿”å›:     â”‚                   â”‚     â”‚
    â”‚   â”‚                        â”‚ gateway_2 â”‚                   â”‚     â”‚
    â”‚   â”‚                        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                   â”‚     â”‚
    â”‚   â”‚                              â”‚                         â”‚     â”‚
    â”‚   â”‚                              â”‚ 3. PUBLISH channel:gateway_2  â”‚
    â”‚   â”‚                              â–¼                         â”‚     â”‚
    â”‚   â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚     â”‚
    â”‚   â”‚                        â”‚ Gateway-2 â”‚                   â”‚     â”‚
    â”‚   â”‚                        â”‚  æ”¶åˆ°è®¢é˜…  â”‚                   â”‚     â”‚
    â”‚   â”‚                        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                   â”‚     â”‚
    â”‚   â”‚                              â”‚                         â”‚     â”‚
    â”‚   â”‚                              â”‚ 4. æ¨é€æ¶ˆæ¯             â”‚     â”‚
    â”‚   â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚     â”‚
    â”‚   â”‚                                                        â”‚     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. è‡ªå®šä¹‰äºŒè¿›åˆ¶åè®® (protocol/protocol.go)

**é—®é¢˜**ï¼šTCP æ˜¯æµå¼åè®®ï¼Œæ²¡æœ‰æ¶ˆæ¯è¾¹ç•Œï¼Œä¼šå¯¼è‡´ç²˜åŒ…/æ‹†åŒ…é—®é¢˜ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šLength-Field-Based åè®®

```
+---------+---------+---------+--------------+
| Length  | Version | CmdType | Body (JSON)  |
| 4 Bytes | 2 Bytes | 2 Bytes |  N Bytes     |
+---------+---------+---------+--------------+
|<-------- å›ºå®š 8 å­—èŠ‚å¤´éƒ¨ ------>|<-- å˜é•¿ -->|
```

**å…³é”®ä»£ç **ï¼š
```go
// è§£åŒ…ï¼šç²¾ç¡®è¯»å–æŒ‡å®šå­—èŠ‚æ•°
header := make([]byte, 8)
io.ReadFull(reader, header)           // è¯»å– 8 å­—èŠ‚å¤´éƒ¨
length := binary.BigEndian.Uint32(header[0:4])
body := make([]byte, length-4)
io.ReadFull(reader, body)             // ç²¾ç¡®è¯»å–æ¶ˆæ¯ä½“
```

### 2. é«˜å¹¶å‘æ¨¡å‹ (server/tcp_server.go)

**Go çš„ Goroutine-per-Connection æ¨¡å‹**ï¼š

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Go Runtime    â”‚
                    â”‚   (Netpoller)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ åº•å±‚ epoll
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚Goroutineâ”‚          â”‚Goroutineâ”‚          â”‚Goroutineâ”‚
   â”‚ç”¨æˆ·å†™æ³•  â”‚          â”‚ç”¨æˆ·å†™æ³•  â”‚          â”‚ç”¨æˆ·å†™æ³•  â”‚
   â”‚åŒæ­¥é˜»å¡  â”‚          â”‚åŒæ­¥é˜»å¡  â”‚          â”‚åŒæ­¥é˜»å¡ â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿**ï¼š
- å†™æ³•ç®€å•ï¼ˆåŒæ­¥é˜»å¡é£æ ¼ï¼‰
- æ€§èƒ½é«˜ï¼ˆåº•å±‚è‡ªåŠ¨ä½¿ç”¨ epollï¼‰
- Goroutine è½»é‡ï¼ˆ2KB åˆå§‹æ ˆ vs çº¿ç¨‹ 8MBï¼‰

### 3. è¿æ¥ç®¡ç† (server/connection.go)

**è¯»å†™åˆ†ç¦»æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Connection                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è¯»åç¨‹     â”‚  â”‚   å†™åç¨‹    â”‚  â”‚
â”‚  â”‚  readLoop   â”‚  â”‚  writeLoop  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                â”‚         â”‚
â”‚         â–¼                â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   writeChan (å¸¦ç¼“å†²é€šé“)     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. ä¼šè¯ç®¡ç† (service/session.go)

**å¿ƒè·³ç»­æœŸæœºåˆ¶**ï¼š

```
æ—¶é—´è½´
â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â–¶
    â”‚      â”‚      â”‚      â”‚      â”‚
   ç™»å½•   å¿ƒè·³1  å¿ƒè·³2  å¿ƒè·³3   ...
    â”‚      â”‚      â”‚      â”‚
    â–¼      â–¼      â–¼      â–¼
   åˆ›å»º   ç»­æœŸ   ç»­æœŸ   ç»­æœŸ
   TTL    TTL    TTL    TTL
  5åˆ†é’Ÿ  5åˆ†é’Ÿ  5åˆ†é’Ÿ  5åˆ†é’Ÿ

å¦‚æœåœæ­¢å¿ƒè·³ï¼ŒKey è‡ªåŠ¨è¿‡æœŸï¼Œç”¨æˆ·å˜ä¸ºç¦»çº¿
```

### 5. æ¶ˆæ¯è·¯ç”± (service/message.go)

**è·¯ç”±å†³ç­–æµç¨‹**ï¼š

```go
// ç®€åŒ–çš„è·¯ç”±é€»è¾‘
func SendMessage(from, to, content string) {
    // 1. ç”Ÿæˆåºåˆ—å·
    seqID := redis.INCR("seq:" + conversationID)
    
    // 2. æŸ¥è¯¢ç›®æ ‡ä½ç½®
    gateway := redis.GET("user_gateway:" + to)
    
    // 3. è·¯ç”±å†³ç­–
    if gateway == "" {
        // ç¦»çº¿ï¼šå­˜å…¥ç¦»çº¿ç›’å­
        redis.ZADD("msg_box:"+to, seqID, content)
    } else if gateway == currentGateway {
        // æœ¬åœ°ï¼šç›´æ¥æ¨é€
        conn := connManager.Get(to)
        conn.Send(content)
    } else {
        // è¿œç¨‹ï¼šPub/Sub è½¬å‘
        redis.PUBLISH("channel:"+gateway, content)
    }
}
```

### 6. ç¦»çº¿æ¶ˆæ¯ (service/offline.go)

**Redis ZSet å­˜å‚¨**ï¼š

```
Key: msg_box:bob
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Score (SeqID)  â”‚      Member       â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚       1         â”‚  {"from":"alice"} â”‚
â”‚       2         â”‚  {"from":"carol"} â”‚
â”‚       3         â”‚  {"from":"alice"} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼š
- è‡ªåŠ¨æŒ‰ SeqID æ’åº
- æ”¯æŒèŒƒå›´æŸ¥è¯¢ (ZRANGEBYSCORE)
- æ”¯æŒåå‘æŸ¥è¯¢ (ZREVRANGE) - ä¸‹æ‹‰åŠ è½½å†å²
```

---

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒå‡†å¤‡ (Ubuntu)

```bash
# 1. å®‰è£… Go
sudo snap install go --classic
go version

# 2. å®‰è£… Redis
sudo apt update
sudo apt install redis-server -y
sudo systemctl start redis-server
redis-cli ping  # åº”è¿”å› PONG
```

### ç¼–è¯‘è¿è¡Œ

```bash
# å…‹éš†/å¤åˆ¶é¡¹ç›®
cd ~/projects/go-im

# ä¸‹è½½ä¾èµ–
go mod tidy

# ç¼–è¯‘
go build -o bin/server ./cmd/main.go
go build -o bin/client ./cmd/client/main.go

# å¯åŠ¨æœåŠ¡å™¨
./bin/server -id gateway_1 -addr :8080 -redis 127.0.0.1:6379

# æ–°ç»ˆç«¯ï¼šå¯åŠ¨å®¢æˆ·ç«¯ (alice)
./bin/client -user alice -server 127.0.0.1:8080

# æ–°ç»ˆç«¯ï¼šå¯åŠ¨å®¢æˆ·ç«¯ (bob)
./bin/client -user bob -server 127.0.0.1:8080

# åœ¨ alice ç»ˆç«¯å‘é€æ¶ˆæ¯
send bob Hello, Bob!

# bob ç»ˆç«¯ä¼šæ”¶åˆ°
# [alice] â†’ Hello, Bob!
```

---

## ä»£ç å¯¼è¯»

### é¡¹ç›®ç»“æ„

```
go-im/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ main.go              # ğŸš€ ä»è¿™é‡Œå¼€å§‹çœ‹ï¼æœåŠ¡ç«¯å…¥å£
â”‚   â””â”€â”€ client/main.go       # æµ‹è¯•å®¢æˆ·ç«¯
â”œâ”€â”€ protocol/
â”‚   â””â”€â”€ protocol.go          # â­ äºŒè¿›åˆ¶åè®®ï¼Œè§£å†³ TCP ç²˜åŒ…
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ tcp_server.go        # â­ TCP æœåŠ¡å™¨ï¼ŒGoroutine æ¨¡å‹
â”‚   â””â”€â”€ connection.go        # è¿æ¥å°è£…ï¼Œè¯»å†™åˆ†ç¦»
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ auth.go              # JWT è®¤è¯
â”‚   â”œâ”€â”€ session.go           # â­ Redis ä¼šè¯ï¼Œå¿ƒè·³ç»­æœŸ
â”‚   â”œâ”€â”€ pubsub.go            # â­ Pub/Sub è·¨èŠ‚ç‚¹è·¯ç”±
â”‚   â”œâ”€â”€ sequence.go          # Redis INCR æ¶ˆæ¯åºå·
â”‚   â”œâ”€â”€ offline.go           # â­ ZSet ç¦»çº¿æ¶ˆæ¯
â”‚   â””â”€â”€ message.go           # â­ æ¶ˆæ¯è·¯ç”±æ ¸å¿ƒé€»è¾‘
â””â”€â”€ pkg/redis/
    â””â”€â”€ client.go            # Redis è¿æ¥æ± 
```

### å»ºè®®é˜…è¯»é¡ºåº

1. **protocol/protocol.go** - ç†è§£äºŒè¿›åˆ¶åè®®å’Œç²˜åŒ…è§£å†³æ–¹æ¡ˆ
2. **server/tcp_server.go** - ç†è§£ Go çš„é«˜å¹¶å‘ç½‘ç»œæ¨¡å‹
3. **server/connection.go** - ç†è§£è¿æ¥ç®¡ç†å’Œè¯»å†™åˆ†ç¦»
4. **service/session.go** - ç†è§£ Redis åœ¨çŠ¶æ€ç®¡ç†ä¸­çš„åº”ç”¨
5. **service/message.go** - ç†è§£æ¶ˆæ¯è·¯ç”±çš„æ ¸å¿ƒé€»è¾‘
6. **service/pubsub.go** - ç†è§£è·¨èŠ‚ç‚¹é€šä¿¡
7. **cmd/main.go** - ç†è§£æ•´ä½“ç»„è£…å’Œå¯åŠ¨æµç¨‹

---

## Redis æ•°æ®ç»“æ„

```bash
# æŸ¥çœ‹æ‰€æœ‰ Key
redis-cli KEYS "*"

# ç”¨æˆ·ä¼šè¯ (Hash)
redis-cli HGETALL "user_session:alice"
# gateway_id: gateway_1
# conn_id: 1
# login_time: 1699999999

# ç”¨æˆ·æ‰€åœ¨ç½‘å…³ (String)
redis-cli GET "user_gateway:alice"
# gateway_1

# ç¦»çº¿æ¶ˆæ¯ (ZSet)
redis-cli ZRANGE "msg_box:bob" 0 -1 WITHSCORES
# {"from":"alice",...}  1
# {"from":"carol",...}  2

# æ¶ˆæ¯åºåˆ—å· (String)
redis-cli GET "seq:alice:bob"
# 42

# æŸ¥çœ‹ TTL
redis-cli TTL "user_session:alice"
# 287 (ç§’)
```

---

## å­¦ä¹ è·¯çº¿

### ç¬¬ä¸€é˜¶æ®µï¼šTCP åŸºç¡€
1. ç†è§£ TCP ç²˜åŒ…é—®é¢˜
2. å®ç°è‡ªå®šä¹‰åè®®
3. å®Œæˆ Echo Server

### ç¬¬äºŒé˜¶æ®µï¼šGo å¹¶å‘
1. ç†è§£ Goroutine è½»é‡çº§ç‰¹æ€§
2. ç†è§£ Go Netpoller (åº•å±‚ epoll)
3. ç†è§£ Channel é€šä¿¡

### ç¬¬ä¸‰é˜¶æ®µï¼šçŠ¶æ€ç®¡ç†
1. Redis åŸºç¡€æ•°æ®ç»“æ„
2. åˆ©ç”¨ EXPIRE å®ç°å¿ƒè·³
3. åˆ©ç”¨ Pipeline å‡å°‘ RTT

### ç¬¬å››é˜¶æ®µï¼šåˆ†å¸ƒå¼
1. Redis Pub/Sub æ¶ˆæ¯åˆ†å‘
2. è·¨èŠ‚ç‚¹æ¶ˆæ¯è·¯ç”±
3. ç¦»çº¿æ¶ˆæ¯å­˜å‚¨

---

## å¸¸è§é—®é¢˜

### Q: Redis è¿æ¥å¤±è´¥
```bash
sudo systemctl status redis-server
sudo systemctl start redis-server
```

### Q: ç«¯å£è¢«å ç”¨
```bash
sudo lsof -i :8080
./bin/server -addr :9090
```

### Q: æ¶ˆæ¯æ”¶ä¸åˆ°
ç¡®ä¿ï¼š
1. æœåŠ¡å™¨æ—¥å¿—æ˜¾ç¤º `[Message] Delivering message...`
2. ä¸¤ä¸ªç”¨æˆ·éƒ½å·²è®¤è¯æˆåŠŸ
3. ç”¨æˆ·åæ‹¼å†™æ­£ç¡®

---

## æŠ€æœ¯äº®ç‚¹

1. **åè®®è®¾è®¡**: è‡ªå®šä¹‰ Length-Field åè®®è§£å†³ TCP ç²˜åŒ…
2. **å¹¶å‘æ¨¡å‹**: Goroutine-per-Connectionï¼Œå¼€å‘ç®€å•æ€§èƒ½é«˜
3. **çŠ¶æ€ç®¡ç†**: Redis EXPIRE å®ç°è½»é‡çº§å¿ƒè·³æ£€æµ‹
4. **æ¶ˆæ¯è·¯ç”±**: Pub/Sub å®ç°è·¨èŠ‚ç‚¹é€æ˜è½¬å‘
5. **æ¶ˆæ¯æ—¶åº**: Redis INCR ä¿è¯å…¨å±€æœ‰åº
6. **ä¼˜é›…å…³é—­**: Graceful Shutdown ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±

---

## License

MIT License
